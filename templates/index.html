<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>{{ weather.city }} ë‚ ì”¨</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet" />
  <style>
    body {
      background-size: cover;
            background-repeat: no-repeat;
            background-attachment: fixed;
            color: white;
            font-family: sans-serif;
            padding: 20px;
        }

    h1, h2, h3 {
      font-size: 24px;
      margin-top: 30px;
      color: white;
    }
    form {
      margin-bottom: 16px;
      position: relative;
    }
    input[type="text"] {
      padding: 8px;
      font-size: 16px;
      width: 200px;
    }
    button {
      padding: 8px 12px;
      font-size: 16px;
      margin-left: 6px;
    }
    #suggestions {
      position: absolute;
      top: 38px;
      left: 0;
      border: 1px solid #ccc;
      background: #fff;
      width: 200px;
      z-index: 10;
      max-height: 150px;
      overflow-y: auto;
    }
    .suggestion-item {
      padding: 6px 8px;
      cursor: pointer;
    }
    .suggestion-item:hover {
      background-color: #eee;
    }
    ul {
      list-style: none;
      padding-left: 0;
      font-size: 17px;
      margin-top: 20px;
    }
    li {
      margin-bottom: 8px;
    }
    .note {
      font-size: 14px;
      color: gray;
    }
    .error {
      color: red;
      margin-top: 12px;
    }
    .group {
      border: 1px solid #ccc;
      padding: 10px;
      margin-top: 15px;
      color: white;
    }
    .row {
      margin-bottom: 10px;
      color: white;
    }
    .result {
      margin-top: 10px;
      background: #eef1f4;
      padding: 8px 12px;
      border-radius: 4px;
      color: white;
    }
  </style>
</head>
<body id="main-body">
  <h1>{{ weather.city }}ì˜ í˜„ì¬ ë‚ ì”¨</h1>

  <form method="GET" action="/">
    <input type="text" name="city" id="city-input" placeholder="ë„ì‹œ ì´ë¦„ ì…ë ¥" autocomplete="off" required />
    <button type="submit">ë‚ ì”¨ ì¡°íšŒ</button>
    <div id="suggestions"></div>
  </form>

  <a href="/history">ê²€ìƒ‰ ê¸°ë¡ ë³´ê¸°</a>

  <p class="note">ë„ì‹œëª…ì´ ì¸ì‹ë˜ì§€ ì•Šìœ¼ë©´ <strong>ì˜ë¬¸ìœ¼ë¡œ, ì²« ê¸€ìë¥¼ ëŒ€ë¬¸ìë¡œ</strong> ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: Busan)</p>

  {% if weather.error %}
    <p class="error">{{ weather.error }}</p>
  {% else %}
    <ul>
      <li><strong>ê¸°ì˜¨:</strong> <span id="temp">{{ weather.temperature }}</span>Â°C</li>
      <li><strong>ê°•ìˆ˜ëŸ‰(1ì‹œê°„):</strong> <span id="rain">{{ weather.rain }}</span> mm</li>
      <li><strong>ìŠµë„:</strong> <span id="humidity">{{ weather.humidity }}</span>%</li>
      <li><strong>ì„¤ëª…:</strong> <span id="desc">{{ weather.description }}</span></li>
    {% if weather.delta_temp is defined %}
      <li><strong>ê¸°ì˜¨ ë³€í™”:</strong>
                {% if weather.delta_temp is not none %}
                    {% if weather.delta_temp > 0 %}+{{ weather.delta_temp }}Â°C (ìƒìŠ¹)
                    {% elif weather.delta_temp < 0 %}{{ weather.delta_temp }}Â°C (í•˜ê°•)
                    {% else %}ë³€í™” ì—†ìŒ{% endif %}
                {% else %}-{% endif %}
            </li>
      {% endif %}
            <li><strong>ìŠµë„ ë³€í™”:</strong>
                {% if weather.delta_humidity is not none %}
                    {% if weather.delta_humidity > 0 %}+{{ weather.delta_humidity }}% (ìƒìŠ¹)
                    {% elif weather.delta_humidity < 0 %}{{ weather.delta_humidity }}% (í•˜ê°•)
                    {% else %}ë³€í™” ì—†ìŒ{% endif %}
                {% else %}-{% endif %}
            </li>
    </ul>

    <h2>ìµœê·¼ ë‚ ì”¨ ë³€í™” (3ì¼)</h2>
        {% if chart_data.dates|length < 2 %}
            <p style="color: lightgray;">* ê·¸ë˜í”„ëŠ” ìµœê·¼ 3ì¼ê°„ì˜ ê²€ìƒ‰ ê¸°ë¡ì´ ìŒ“ì´ë©´ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.</p>
        {% endif %}
        <canvas id="weatherChart" width="400" height="200"></canvas>

  {% endif %}

 <hr>

    <!-- ë‰´ìŠ¤ ê²€ìƒ‰ -->
    <h2>ë‰´ìŠ¤ ê²€ìƒ‰</h2>
    <form method="post" action="/">
        <input type="text" name="query" placeholder="ë‰´ìŠ¤ í‚¤ì›Œë“œ ì…ë ¥" required>
        <button type="submit">ë‰´ìŠ¤ ê²€ìƒ‰</button>
    </form>

    {% if news_error %}
        <p style="color:red;">{{ news_error }}</p>
    {% endif %}

    {% if news_articles %}
        <ul>
        {% for article in news_articles %}
            <li><a href="{{ article.url }}" target="_blank">{{ article.title }}</a></li>
        {% endfor %}
        </ul>
    {% endif %}



  <h2>ğŸ“‹ ì €ì¥ëœ ì¦ê²¨ì°¾ê¸°</h2>
  <div id="favorites-list"></div>
  <div id="group-weather-result"></div>

  <h2>â­ ì¦ê²¨ì°¾ê¸° ê·¸ë£¹ ë§Œë“¤ê¸°</h2>
  <form id="group-form">
    <label>ê·¸ë£¹ ì´ë¦„: <input type="text" id="group-name" required /></label><br /><br />
    <div id="days-container"></div>
    <button type="submit">ê·¸ë£¹ ì €ì¥</button>
  </form>

  <script>
    const weekdays = ['ì›”ìš”ì¼', 'í™”ìš”ì¼', 'ìˆ˜ìš”ì¼', 'ëª©ìš”ì¼', 'ê¸ˆìš”ì¼', 'í† ìš”ì¼', 'ì¼ìš”ì¼'];

    function createDayInputs() {
      const container = document.getElementById('days-container');
      container.innerHTML = '';
      weekdays.forEach(day => {
        const div = document.createElement('div');
        div.classList.add('row');
        div.innerHTML = `
          <label><input type="checkbox" class="day-check" data-day="${day}"> <strong>${day}</strong></label><br>
          ë„ì‹œ: <input type="text" class="city" data-day="${day}" disabled><br>
          ì‹œê°„: 
          <select class="hour" data-day="${day}" disabled>
            ${[...Array(24).keys()].map(h => `<option value="${h.toString().padStart(2, '0')}">${h}</option>`).join('')}
          </select>ì‹œ
          <select class="minute" data-day="${day}" disabled>
            ${['00','10','20','30','40','50'].map(m => `<option value="${m}">${m}</option>`).join('')}
          </select>ë¶„
          <br><br>
        `;
        container.appendChild(div);
      });

      document.querySelectorAll('.day-check').forEach(chk => {
        chk.addEventListener('change', () => {
          const day = chk.dataset.day;
          document.querySelector(`.city[data-day="${day}"]`).disabled = !chk.checked;
          document.querySelector(`.hour[data-day="${day}"]`).disabled = !chk.checked;
          document.querySelector(`.minute[data-day="${day}"]`).disabled = !chk.checked;
        });
      });
    }

    createDayInputs();

    document.getElementById('group-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('group-name').value;
      const entries = [];
      weekdays.forEach(day => {
        const check = document.querySelector(`.day-check[data-day="${day}"]`).checked;
        if (check) {
          const city = document.querySelector(`.city[data-day="${day}"]`).value;
          const hour = document.querySelector(`.hour[data-day="${day}"]`).value;
          const minute = document.querySelector(`.minute[data-day="${day}"]`).value;
          entries.push({ weekday: day, city, time: `${hour}:${minute}` });
        }
      });
      const response = await fetch('/add-group', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, entries })
      });
      const data = await response.json();
      updateGroups(data.groups);
    });

    function updateGroups(groups) {
      const list = document.getElementById('favorites-list');
      list.innerHTML = '';
      groups.forEach(group => {
        const div = document.createElement('div');
        div.className = 'group';
        div.innerHTML = `
          <strong>${group.group_name}</strong><br>
          ${group.entries.map(t => `${t.weekday} (${t.city} ${t.time})`).join('<br>')}<br>
          <button onclick="fetchGroupWeather('${group.group_name}')">ì¡°íšŒ</button>
          <button onclick="deleteGroup('${group.group_name}')">ì‚­ì œ</button>
        `;
        list.appendChild(div);
      });
    }

    async function fetchGroupWeather(groupName) {
      const res = await fetch(`/get-group-weather?group=${encodeURIComponent(groupName)}`);
      const data = await res.json();
      const result = document.getElementById('group-weather-result');
      result.innerHTML = '';
      if (data.results) {
        result.innerHTML = '<h3>ğŸ“Š ' + groupName + ' ê·¸ë£¹ ë‚ ì”¨ ì •ë³´</h3>';
        data.results.forEach(d => {
          const div = document.createElement('div');
          div.className = 'result';
          div.innerHTML = `
            <strong>${d.weekday} ${d.time} - ${d.city}</strong><br>
            ê¸°ì˜¨: ${d.temperature}Â°C<br>
            ê°•ìˆ˜ëŸ‰(1ì‹œê°„): ${d.rain ?? 0} mm<br>
            ìŠµë„: ${d.humidity}%<br>
            ì„¤ëª…: ${d.description}<br>
          `;
          result.appendChild(div);
        });
      }
    }

    async function deleteGroup(groupName) {
      await fetch(`/delete-group`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: groupName })
      });
      loadGroups();
    }

    async function loadGroups() {
      const res = await fetch('/groups');
      const data = await res.json();
      updateGroups(data);
    }

    loadGroups();

    function fetchWeather() {
      const params = new URLSearchParams(window.location.search);
      const city = params.get('city') || 'Seoul';
      fetch(`/weather-data?city=${city}`)
        .then(res => res.json())
        .then(data => {
          if (!data.error) {
            document.getElementById('temp').innerText = data.temperature;
            document.getElementById('rain').innerText = data.rain;
            document.getElementById('humidity').innerText = data.humidity;
            document.getElementById('desc').innerText = data.description;
          }
        });
    }
    fetchWeather();
    setInterval(fetchWeather, 60000);

    const input = document.getElementById('city-input');
    const suggestions = document.getElementById('suggestions');
    input.addEventListener('input', () => {
      const query = input.value;
      if (query.length < 1) {
        suggestions.innerHTML = '';
        return;
      }
      fetch(`/autocomplete?q=${query}`)
        .then(res => res.json())
        .then(data => {
          suggestions.innerHTML = '';
          data.forEach(item => {
            const div = document.createElement('div');
            div.classList.add('suggestion-item');
            div.textContent = item;
            div.addEventListener('click', () => {
              input.value = item;
              suggestions.innerHTML = '';
            });
            suggestions.appendChild(div);
          });
        });
    });
    </script>

    <!-- ì‚¬ìš©ì ì°¨íŠ¸ ë° ë°°ê²½ ì„¤ì • -->
     {% if chart_data %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const labels = {{ chart_data.dates | tojson }};
        const temps = {{ chart_data.temps | tojson }};
        const humidities = {{ chart_data.humidities | tojson }};
        const ctx = document.getElementById('weatherChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'ê¸°ì˜¨ (Â°C)', data: temps, borderColor: 'red', fill: false },
                    { label: 'ìŠµë„ (%)', data: humidities, borderColor: 'blue', fill: false }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: false }
                }
            }
        });

        const desc = "{{ weather.description }}";
        const main = "{{ weather.main }}"; // ë°°ê²½ ì¡°ê±´ ë¶„ë¥˜ìš©
        const body = document.getElementById("main-body");
        if (main === "Rain" || main === "Drizzle") {
            body.style.backgroundImage = "url('/static/rainy.gif')";
        } else if (main === "Clouds") {
            body.style.backgroundImage = "url('/static/cloudy.jpg')";
        } else if (main === "Clear") {
            body.style.backgroundImage = "url('/static/sunny.jpg')";
        } else if (main === "Snow") {
            body.style.backgroundImage = "url('/static/snowy.gif')";
        } else if (main === "Mist" || main === "Fog" || main === "Haze") {
            body.style.backgroundImage = "url('/static/foggy.jpg')";
        } else {
            body.style.backgroundImage = "url('/static/cloudy.jpg')";
        }
  </script>
  {% endif %}
</body>
</html>
